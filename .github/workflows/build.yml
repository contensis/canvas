name: Node.js build

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Use Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20.x'

      - name: Install dependencies
        run: npm install

      - name: Build all workspace packages
        run: npm run build --if-present --workspaces

      - name: Make local packages
        run: cd packages && npm pack --workspace ./**

      - name: Upload packaged artifacts
        uses: actions/upload-artifact@v3
        with:
          name: contensis-canvas-packages
          path: ./packages/*.tgz

  publish-changes:
    runs-on: ubuntu-latest
    outputs:
      canvas-html: ${{ steps.publish-package.outputs.html }}
      canvas-react: ${{ steps.publish-package.outputs.react }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # OR "2" -> To retrieve the preceding commit.

      - name: Find changes in packages
        id: changed-packages
        uses: tj-actions/changed-files@v40
        with:
          files: '**'
          files_yaml: |
            canvas-html: 
              - packages/html/**
              - packages/dom/**
              - packages/types/**
            canvas-react: 
              - packages/react/**
              - packages/types/**

      - name: Check if any file(s) in the packages have changed
        id: publish-package
        run: |
          for file in ${{ steps.changed-packages.outputs.all_changed_files }}; do
            echo "$file was changed"
          done
          echo "html=${{ steps.changed-packages.outputs.canvas-html_any_changed }}" > $GITHUB_OUTPUT
          echo "react=${{ steps.changed-packages.outputs.canvas-react_any_changed }}" > $GITHUB_OUTPUT

      - uses: ./.github/workflows/publish.yml
        with:
          package: html
          publish: false # ${{ steps.publish-package.outputs.html }}

      - uses: ./.github/workflows/publish.yml
        with:
          package: react
          publish: false # ${{ steps.publish-package.outputs.react }}
