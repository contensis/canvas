name: Node.js build

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Use Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20.x'

      - name: Install dependencies
        run: npm install

      - name: Build all workspace packages
        run: npm run build --if-present --workspaces

      - name: Make local packages
        run: cd packages && npm pack --workspace ./**

      - name: Upload packaged artifacts
        uses: actions/upload-artifact@v3
        with:
          name: contensis-canvas-packages
          path: ./packages/*.tgz

  publish:
    runs-on: ubuntu-latest
    outputs:
      html: ${{ steps.changed-packages.outputs.html }}
      react: ${{ steps.changed-packages.outputs.react }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # OR "2" -> To retrieve the preceding commit.

      - name: Find changes in packages
        id: changes
        uses: tj-actions/changed-files@v40
        with:
          files: '**'
          files_yaml: |
            canvas-html: 
              - packages/html/**
              - packages/dom/**
              - packages/types/**
            canvas-react: 
              - packages/react/**
              - packages/types/**

      - name: Check if any file(s) in the packages have changed
        id: changed-packages
        run: |
          for file in ${{ steps.changes.outputs.all_changed_files }}; do
            echo "$file was changed"
          done
          echo "html=${{ steps.changes.outputs.canvas-html_any_changed == 'true' && true || false }}" >> $GITHUB_OUTPUT
          echo "react=${{ steps.changes.outputs.canvas-react_any_changed == 'true' && true  || false }}" >> $GITHUB_OUTPUT

  canvas-html:
    needs: publish
    uses: ./.github/workflows/publish.yml
    with:
      package: html
      publish: ${{ needs.publish.outputs.html }}
    secrets: inherit

  canvas-react:
    needs: publish
    uses: ./.github/workflows/publish.yml
    with:
      package: react
      publish: false # ${{ needs.publish.outputs.react }}
    secrets: inherit
